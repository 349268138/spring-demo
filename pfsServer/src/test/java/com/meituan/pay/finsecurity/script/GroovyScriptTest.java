package com.meituan.pay.finsecurity.script;

import com.meituan.pay.finsecurity.constant.ScriptConstant;
import org.junit.Assert;
import org.junit.Test;

/**
 * @author wangjinping
 * @Description
 * @CreateDateon 2020/11/4.
 */
public class GroovyScriptTest {

    @Test
    public void scriptSuccessTest() {
        String expr = "return eventData.id";
        Long expectedId = 2340516932L;
        Long actualId = Long.parseLong(GroovyScript.script(ScriptConstant.EVENT_DATA, obtainJsonData(), expr).toString());
        Assert.assertEquals(expectedId, actualId);
    }

    @Test
    public void scriptErrorTest() {
        String expr = "return eventData1.id";
        try {
            GroovyScript.script(ScriptConstant.EVENT_DATA, obtainJsonData(), expr);
            Assert.fail();
        } catch (Exception e) {
            Assert.assertTrue(e.getMessage().contains("excute script error"));
        }
    }

    private String obtainJsonData() {
//        return "{\"id\":2340516932,\"partnerid\":0,\"business_type\":1,\"split_funds_records\":null,\"merchantno\":\"22010191646623441\",\"mohash\":2526105,\"notifyurl\":\"thrift://com.sankuai.pay.merchantproduct.mwalletcore:3426\",\"name\":\"于娓\",\"acctype\":2,\"money\":456577,\"city\":320300,\"bank\":3,\"branchid\":53748,\"branchname\":\"中国邮政储蓄银行股份有限公司徐州市分行营业部\",\"account\":0,\"fkaccount\":19,\"fixchannel\":0,\"channel\":0,\"comment\":\"\",\"reason\":\"\",\"status\":64,\"notifystatus\":0,\"addtime\":1603095393,\"sendtime\":1603095393,\"recvtime\":1603095395,\"succtime\":1603095396,\"failtime\":0,\"notifytime\":0,\"modtime\":1603095395,\"priority\":1603102593,\"extended_data\":\"{\\\"transIdForCheckingAccount\\\":\\\"\\\",\\\"feeBizCode\\\":\\\"2005\\\",\\\"isTransfer\\\":false,\\\"billMerchantOrderId\\\":\\\"22010191646623441\\\",\\\"batchTransferInfoList\\\":\\\"[]\\\",\\\"withdrawReqType\\\":0,\\\"needNotifyClearingCenter\\\":true,\\\"unwithdrawToPayTransferWay\\\":\\\"actTransfer\\\",\\\"needNotifyTradeDataCenter\\\":true,\\\"billTradeType\\\":\\\"ZJ03\\\",\\\"billTradeId\\\":\\\"2340516932\\\",\\\"noAvailableCountMoney\\\":0,\\\"final_pay_company_code\\\":\\\"QDB\\\",\\\"billTradeChannel\\\":\\\"QD02\\\",\\\"hasSend\\\":\\\"1\\\",\\\"phyChannelCode\\\":\\\"netsunionAcs\\\",\\\"phyChannelName\\\":\\\"网联ACS全渠道\\\",\\\"logicalChannelAccountNo\\\":\\\"991100000111\\\",\\\"logicalChannelId\\\":181,\\\"payCoreMtpp\\\":\\\"mtpp_1095129106_11560614217\\\",\\\"billAccountTime\\\":0}\",\"card_id\":236548639,\"trade_no\":\"1602748863780\",\"iph_pay_merchant_no\":12000102584584,\"queuing_type\":0,\"pay_to_card_biz_req_code\":2005,\"pay_prod_type\":1,\"pay_to_card_account_type\":101,\"from_sub_account_id\":0,\"fee_code\":\"\",\"order_time\":1603095393000,\"fee\":0,\"return_fee\":1,\"start_pay_date\":0,\"error_code\":\"FT2O0000\",\"error_msg\":\"付款成功\"}";
        return "{\"eventData\":\"{\\\"id\\\":99999999999,\\\"partnerid\\\":0,\\\"business_type\\\":1,\\\"split_funds_records\\\":null,\\\"merchantno\\\":\\\"22010191646623441\\\",\\\"mohash\\\":2526105,\\\"notifyurl\\\":\\\"thrift://com.sankuai.pay.merchantproduct.mwalletcore:3426\\\",\\\"name\\\":\\\"张三六\\\",\\\"acctype\\\":2,\\\"money\\\":1,\\\"city\\\":320300,\\\"bank\\\":3,\\\"branchid\\\":53748,\\\"branchname\\\":\\\"中国邮政储蓄银行股份有限公司徐州市分行营业部\\\",\\\"account\\\":0,\\\"fkaccount\\\":19,\\\"fixchannel\\\":0,\\\"channel\\\":0,\\\"comment\\\":\\\"\\\",\\\"reason\\\":\\\"\\\",\\\"status\\\":64,\\\"notifystatus\\\":0,\\\"addtime\\\":1603095393,\\\"sendtime\\\":1603095393,\\\"recvtime\\\":1603095395,\\\"succtime\\\":1603095396,\\\"failtime\\\":0,\\\"notifytime\\\":0,\\\"modtime\\\":1603095395,\\\"priority\\\":1603102593,\\\"extended_data\\\":\\\"{\\\\\\\"transIdForCheckingAccount\\\\\\\":\\\\\\\"\\\\\\\",\\\\\\\"feeBizCode\\\\\\\":\\\\\\\"2005\\\\\\\",\\\\\\\"isTransfer\\\\\\\":false,\\\\\\\"billMerchantOrderId\\\\\\\":\\\\\\\"22010191646623441\\\\\\\",\\\\\\\"batchTransferInfoList\\\\\\\":\\\\\\\"[]\\\\\\\",\\\\\\\"withdrawReqType\\\\\\\":0,\\\\\\\"needNotifyClearingCenter\\\\\\\":true,\\\\\\\"unwithdrawToPayTransferWay\\\\\\\":\\\\\\\"actTransfer\\\\\\\",\\\\\\\"needNotifyTradeDataCenter\\\\\\\":true,\\\\\\\"billTradeType\\\\\\\":\\\\\\\"ZJ03\\\\\\\",\\\\\\\"billTradeId\\\\\\\":\\\\\\\"2340516932\\\\\\\",\\\\\\\"noAvailableCountMoney\\\\\\\":0,\\\\\\\"final_pay_company_code\\\\\\\":\\\\\\\"QDB\\\\\\\",\\\\\\\"billTradeChannel\\\\\\\":\\\\\\\"QD02\\\\\\\",\\\\\\\"hasSend\\\\\\\":\\\\\\\"1\\\\\\\",\\\\\\\"phyChannelCode\\\\\\\":\\\\\\\"netsunionAcs\\\\\\\",\\\\\\\"phyChannelName\\\\\\\":\\\\\\\"网联ACS全渠道\\\\\\\",\\\\\\\"logicalChannelAccountNo\\\\\\\":\\\\\\\"991100000111\\\\\\\",\\\\\\\"logicalChannelId\\\\\\\":181,\\\\\\\"payCoreMtpp\\\\\\\":\\\\\\\"mtpp_1095129106_11560614217\\\\\\\",\\\\\\\"billAccountTime\\\\\\\":0}\\\",\\\"card_id\\\":236548639,\\\"trade_no\\\":\\\"30084604\\\",\\\"iph_pay_merchant_no\\\":12000102584584,\\\"queuing_type\\\":0,\\\"pay_to_card_biz_req_code\\\":2005,\\\"pay_prod_type\\\":1,\\\"pay_to_card_account_type\\\":101,\\\"from_sub_account_id\\\":0,\\\"fee_code\\\":\\\"\\\",\\\"order_time\\\":1603095393000,\\\"fee\\\":0,\\\"return_fee\\\":1,\\\"start_pay_date\\\":0,\\\"error_code\\\":\\\"FT2O0000\\\",\\\"error_msg\\\":\\\"付款成功\\\"}\",\"tradeData\":\"{\\\"paycore\\\":{\\\"accountInvokeLogList\\\":[{\\\"accountType\\\":212,\\\"addTime\\\":1606121044000,\\\"bizOrderTime\\\":1606121044000,\\\"bizType\\\":19008,\\\"comment\\\":\\\"建行二类户提现\\\",\\\"customerId\\\":21000048793184,\\\"feeCode\\\":\\\"\\\",\\\"feeMoney\\\":0,\\\"finalStatus\\\":true,\\\"freezeToken\\\":1330794230481690659,\\\"id\\\":87810229,\\\"invokeStatus\\\":\\\"INVOKE_SUCCESS\\\",\\\"modTime\\\":1606121044000,\\\"payTaskId\\\":30084604,\\\"provisionId\\\":0,\\\"returnCode\\\":0,\\\"subAccountId\\\":0,\\\"toMoney\\\":1},{\\\"accountType\\\":212,\\\"addTime\\\":1606121045000,\\\"bizOrderTime\\\":1606121045000,\\\"bizType\\\":19009,\\\"comment\\\":\\\"建行二类户提现\\\",\\\"customerId\\\":21000048793184,\\\"feeCode\\\":\\\"\\\",\\\"feeMoney\\\":0,\\\"finalStatus\\\":true,\\\"freezeToken\\\":1330794230481690659,\\\"id\\\":87810235,\\\"invokeStatus\\\":\\\"INVOKE_SUCCESS\\\",\\\"modTime\\\":1606121045000,\\\"payTaskId\\\":30084604,\\\"provisionId\\\":0,\\\"returnCode\\\":0,\\\"subAccountId\\\":0,\\\"toMoney\\\":1}],\\\"payRecordList\\\":[{\\\"addTime\\\":1606121045000,\\\"channelTradeNo\\\":\\\"10101136815923732DSK072\\\",\\\"id\\\":10023813432,\\\"logicalChannelId\\\":4004,\\\"modTime\\\":1606121045000,\\\"payTaskAddTime\\\":1606121044000,\\\"payTaskId\\\":30084604,\\\"phyChannelCode\\\":\\\"\\\",\\\"phyChannelId\\\":0,\\\"provisionId\\\":0,\\\"receiveData\\\":\\\"()\\\",\\\"returnCode\\\":\\\"FT3S0000\\\",\\\"returnMsg\\\":\\\"付款成功\\\",\\\"sendTime\\\":1606121045000,\\\"status\\\":\\\"SUCCESS\\\",\\\"successTime\\\":1606121045000,\\\"toCdType\\\":\\\"UNKNOW\\\",\\\"toPpType\\\":\\\"PRIVATE\\\"}],\\\"payTask\\\":{\\\"accountType\\\":212,\\\"addTime\\\":1606121044000,\\\"bankCode\\\":\\\"\\\",\\\"branchCode\\\":\\\"\\\",\\\"callerBizType\\\":0,\\\"callerId\\\":10013,\\\"callerUniqueId\\\":\\\"5567188687707294720\\\",\\\"customerId\\\":21000048793184,\\\"disablePayChannelCodes\\\":[\\\"qdbhvbepay\\\",\\\"qdbpay\\\"],\\\"enablePayChannelCodes\\\":[],\\\"extendedData\\\":{\\\"cardInfoCorrect\\\":false,\\\"cardInfoUnCorrectGrayFlag\\\":false,\\\"checkName\\\":false,\\\"failChannelRetryGrayMark\\\":false,\\\"feeBizCode\\\":\\\"\\\",\\\"fromCardId\\\":\\\"132586713\\\",\\\"fromCardName\\\":\\\"张三六\\\",\\\"fundsPlatformGrayFlag\\\":true,\\\"transId\\\":\\\"30084604\\\",\\\"transferScene\\\":0,\\\"useNewIdGrayFlag\\\":false,\\\"userId\\\":\\\"5023132009\\\"},\\\"feeCode\\\":\\\"\\\",\\\"feeMoney\\\":0,\\\"finalLogicalChannelId\\\":4004,\\\"finalPhyChannelCode\\\":\\\"\\\",\\\"finalPhyChannelId\\\":0,\\\"finalProvisionId\\\":0,\\\"fromAccCode\\\":\\\"\\\",\\\"fromAccId\\\":0,\\\"fromCardNo\\\":\\\"6227002920004600805\\\",\\\"id\\\":30084604,\\\"inStatus\\\":\\\"SUCCESS\\\",\\\"modTime\\\":1606151645000,\\\"notifyCount\\\":9,\\\"notifyStatus\\\":\\\"FAIL\\\",\\\"notifyTime\\\":1606151645000,\\\"notifyUrl\\\":\\\"http://127.0.0.1:8080/health/check\\\",\\\"outBizNo\\\":\\\"7233693591499928576\\\",\\\"payProdType\\\":\\\"T_2_H\\\",\\\"preStatus\\\":\\\"COMMIT\\\",\\\"recordId\\\":10023813432,\\\"resultTime\\\":1606121045000,\\\"returnCode\\\":\\\"FT3S0000\\\",\\\"returnFee\\\":false,\\\"returnMsg\\\":\\\"付款成功\\\",\\\"startPayTime\\\":1606121044000,\\\"subAccountId\\\":0,\\\"taskExt\\\":\\\"\\\",\\\"toAccName\\\":\\\"张三六\\\",\\\"toBankId\\\":0,\\\"toBankName\\\":\\\"\\\",\\\"toBranchId\\\":0,\\\"toBranchName\\\":\\\"\\\",\\\"toCardNo\\\":\\\"6217002530004871909\\\",\\\"toCdType\\\":\\\"UNKNOW\\\",\\\"toCityId\\\":0,\\\"toCityName\\\":\\\"\\\",\\\"toComment\\\":\\\"建行二类户提现\\\",\\\"toMoney\\\":1,\\\"toPpType\\\":\\\"PRIVATE\\\",\\\"toProvinceName\\\":\\\"\\\",\\\"tradeTime\\\":1606121044000}}}\"}";
    }

//    @Test
//    public void scriptTest() {
////        String expr = "if(eventData.business_type != 1) return true; if(eventData.trade_no.equals(\"\")) return true; if((eventData.money == tradeData.paycore.payTask.toMoney && eventData.money == tradeData.paycore.accountInvokeLogList[0].toMoney) && (eventData.fee == tradeData.paycore.payTask.feeMoney && eventData.fee == tradeData.paycore.accountInvokeLogList[0].feeMoney)) return true else return false";
//        String expr = "if(eventData.status == 64 || eventData.status == 128 || eventData.status == 160) return 1 else return 0";
//        int result = (int) GroovyScript.script(ScriptConstant.EVENT_DATA, obtainJsonData(), expr);
//        System.out.println(result);
//    }

    @Test
    public void scriptTest() {
//        String expr = "if(eventData.business_type != 1) return true; if(eventData.trade_no.equals(\"\")) return true; if((eventData.money == tradeData.paycore.payTask.toMoney && eventData.money == tradeData.paycore.accountInvokeLogList[0].toMoney) && (eventData.fee == tradeData.paycore.payTask.feeMoney && eventData.fee == tradeData.paycore.accountInvokeLogList[0].feeMoney)) return true else return false";
//        String expr = "if(eventData.business_type != 1) return true; if(eventData.trade_no.equals(\"\")) return true; if((eventData.money == tradeData.paycore.payTask.toMoney && eventData.money == tradeData.paycore.accountInvokeLogList[0].toMoney) && (eventData.fee == tradeData.paycore.payTask.feeMoney && eventData.fee == tradeData.paycore.accountInvokeLogList[0].feeMoney)) return true else return false";
        String expr =
                "if(eventData.business_type != 1) return true; if(eventData.trade_no.equals(\"\")) return true; if(eventData.status == 128) return true; def noneAccountingList = [10013, 10012, 10010, 10004]; if(noneAccountingList.contains(tradeData.paycore.payTask.callerId)) return true; if((eventData.money == tradeData.paycore.payTask.toMoney && eventData.money == tradeData.paycore.accountInvokeLogList[0].toMoney) && (eventData.fee == tradeData.paycore.payTask.feeMoney && eventData.fee == tradeData.paycore.accountInvokeLogList[0].feeMoney)) return true else return false";

        boolean result = (boolean) GroovyScript.script(ScriptConstant.EVENT_DATA, obtainJsonData(), expr);
        System.out.println(result);
    }
}
